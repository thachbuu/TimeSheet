@{
    Layout = "";

    //Initialize variables
    var db = Database.Open("StarterSite");
    var projectId = Request["ProjectId"].AsInt();
    var supervisorId = WebSecurity.CurrentUserId;
    WebGrid userData  = null;


    //Intialize queries
    var members_in_project = "SELECT DISTINCT(UserProfile.UserId), FirstName, LastName, Email,UserCompanyId, Project_User.Status FROM UserProfile, Project_User " + 
                             "WHERE Project_User.UserId !=@0 AND Project_User.ProjectId=@1 AND UserProfile.UserId = Project_User.UserId AND Project_User.Status = 'True' ";

    var members_in_pool_pm = "SELECT DISTINCT(UserProfile.UserId), FirstName, LastName, Email, UserCompanyId, Project_User.Status FROM UserProfile, Project_User " +
                             "WHERE ProjectManagerId=@0 " +
                             "AND (UserProfile.UserId NOT IN (SELECT UserId FROM Project_User WHERE ProjectId=@1) " +
                             "OR  (Project_User.ProjectId =@1 AND UserProfile.UserId = Project_User.UserId AND Project_User.Status = 'False')) ";

     var members_in_pool_leader   = "SELECT DISTINCT(UserProfile.UserId),FirstName, LastName, Email, UserCompanyId, Project_User.Status FROM UserProfile, Project_User " +
                             "WHERE LeaderId=@0 " +
                             "AND (UserProfile.UserId NOT IN (SELECT UserId FROM Project_User WHERE ProjectId=@1) " +
                             "OR  (Project_User.ProjectId =@1 AND UserProfile.UserId = Project_User.UserId AND Project_User.Status = 'False')) ";

    if(User.IsInRole("PM")){
        var queryCombine  = members_in_project + "UNION " + members_in_pool_pm;
        userData = new WebGrid(db.Query(queryCombine,supervisorId,projectId),canSort:false);        
    }
    if(User.IsInRole("LEADER")){
        var queryCombine  = members_in_project + "UNION " + members_in_pool_leader;       
        userData = new WebGrid(db.Query(queryCombine,supervisorId,projectId),canSort:false);        
    }               
   

    if(IsPost){        
        var action = Request["Action"];
        var userId = Request["UserId"];
        
        @*If button "Remove" is pressed.*@
            if(action == "Remove"){
                //Status: 0 -- User is removed from project
                //Status: 1 -- User is joining in this project
                string removeMember = "UPDATE Project_User SET Status=@0 WHERE UserId=@1 AND ProjectId=@2";       
                db.Execute(removeMember,0,userId,projectId);              
            }
            

        @*If button "Add" is pressed.*@
            if(action == "Add" ){                
                var checkUserInProject = db.QuerySingle("SELECT UserId FROM Project_User WHERE UserId=@0 AND ProjectId=@1",userId,projectId);
                if(userId != ""){
                   if(checkUserInProject != null){
                        db.Execute("UPDATE Project_User SET Status=@0 WHERE UserId=@1 AND ProjectId = @2",1,userId,projectId);                      
                   }
                   else{
                        db.Execute("INSERT Project_User(Status,UserId,ProjectId) VALUES (@0,@1,@2)",1,userId,projectId);                       
                   }
                }
            }
    }
}


<script>
    $(function () {       
        $("button[name=AddRemoveUser]").click(function () {
            if ($(this).text() == "Add") {
                $.post("/Leader/GetMembers.cshtml", { UserId: $(this).attr('value'), ProjectId: $("input[id=currentProjectId]").attr('value'), Action: 'Add' });
                alert("Add successfully");
            }
            else {
                 $.post("/Leader/GetMembers.cshtml", { UserId: $(this).attr('value'), ProjectId: $("input[id=currentProjectId]").attr('value'), Action: 'Remove' });
                alert("Remove successfully");
            }
        });
    });               
</script>


<input type="hidden" value="@projectId" id="currentProjectId">
@Html.Label("MEMBER LIST")
@if(userData.TotalRowCount == 0){
    <div>You don't have any members</div>
}
else{
    @userData.GetHtml(
        tableStyle: "grid",
        headerStyle: "gridheader",
        footerStyle: "gridfooter",
                                
        //displayHeader: false,           
        columns: userData.Columns(
            userData.Column(columnName: "FirstName"),
            userData.Column(columnName: "LastName"),
            userData.Column(columnName: "UserCompanyId"),
            userData.Column(columnName: "Email"),                                                           
            userData.Column(format: @<button name="AddRemoveUser" value="@item.UserId" style="float: right; width: 100px">@if(item.Status == true){<text>Remove</text>}else{<text>Add</text>}</button>)
        ))
}


