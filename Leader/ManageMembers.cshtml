@{
    Page.Title= "Manage Your Members";

    //Initalize variable;
    var db = Database.Open("StarterSite");
    WebGrid grid = null;
    var currentUserEmail  = WebSecurity.CurrentUserName;
    var currentUserId = WebSecurity.CurrentUserId;
    var projectList = Functions.getListOfProjectsFromUser(WebSecurity.CurrentUserId,true);
    var titleList = Functions.getSelectListItemOfTitle(true);
    IEnumerable<dynamic> memberList = null;

    if(IsPost){
        if(Request["Action"]=="Add"){
            db.Execute("UPDATE UserProfile SET LeaderId=@0 WHERE UserId=@1",Request["listLeader"].AsInt(),Request["UserId"].AsInt());            
        }
        
        if(Request["Action"]=="Remove"){
            db.Execute("UPDATE UserProfile SET LeaderId=0 WHERE UserId=@0",Request["UserId"].AsInt());            
        }
    }
    if(User.IsInRole("PM")){
        memberList = db.Query("SELECT * FROM UserProfile WHERE ProjectManagerId=@0",currentUserId);        
        grid = new WebGrid(memberList, canSort:false,defaultSort: "Role");        
    }
    if(User.IsInRole("LEADER")){
        memberList = db.Query("SELECT * FROM UserProfile WHERE LeaderId=@0",currentUserId);
        grid = new WebGrid(memberList,canSort:false);        
    }
    
}
<script>
    $(function () {
        $("#mm-memberlist").accordion();
        $("li[id*=mem_]").click(function () {
            var userId = $(this).attr('id').match("[0-9]+").toString(); 
            $.post("/Leader/MemberProfile.cshtml", { UserId: userId}, function(data){$("#mm-memberdetails").html(data)});
        });
    });
</script>

<style>
    li.mm-memberName:hover{
        cursor: pointer
    }
</style>


<div>filter field
    <form method="post">
        <div>
            @Html.Label("Name or Email")
            @Html.TextBox("mm-memberNameOrEmail",Request["mm-memberNameOrEmail"])
        </div>
        <div>
            @Html.Label("Title")
            @Html.DropDownList("mm-titleList",null,titleList,Request["mm-titleList"],null)
        </div>
        <div>
            @Html.Label("Project")
            @Html.DropDownList("mm-projectList",null,projectList,Request["mm-projectList"],null)
        </div>
        <button>Search</button>
    </form>
    <button><a href="/Leader/ManageMembers.cshtml">View All</a></button>
</div>

@if(!IsPost){
<div style="width:  1000px; height: fit-content">    
    <div class="mm-memberlist" id="mm-memberlist"style="vertical-align: top;width: 200px; display: inline-block; margin-right: 20px;">Member List
        @foreach(var prj in projectList){
            if(prj.Text =="All"){continue;}
            <h4>@prj.Text</h4>
            var membersInProject = Functions.getUsersInProject(prj.Value.AsInt());
            <div>
                <ul>
                    @foreach(var mem in membersInProject){
                        <li id="mem_@mem.UserId" class="mm-memberName">@mem.FirstName @mem.LastName</li>
                    }
                </ul>
            </div>
        }
    </div>
    <div class="mm-memberdetails" id="mm-memberdetails" style="padding-left: 3px;width: 700px; display: inline-block; border-left: 2px solid #000">User Details</div>
</div>
}
else{
    var projectId = Request["mm-projectList"].AsInt();
    var titleId = Request["mm-titleList"];
    var memberNameOrEmail = Request["mm-memberNameOrEmail"];

    var projectRangeQuery = projectId==0?"SELECT Id FROM Projects":"SELECT Id FROM Projects WHERE ProjectId=@0";
    var memberRangeQuery = titleId==0?"SELECT Id FROM Title":"SELECT Id FROM Title WHERE TitleId=@1";
    if(projectId==0){
        
    }
    
    <p>ProjectId @projectId</p>
    <p>MemberTitle @memberTitle</p>
    <p>Name: @memberNameOrEmail</p>
}
@*
<script>
    $(function () {
        $("a[id*=assignLeader]").click(function () {
            var userId = $(this).attr("id").match("[0-9].*").toString();
            $("#dialog").dialog({
                title: "Assign To Leader",
                buttons: [{ text: "Save", click: function () {
                    $.post("/Leader/ManageMembers.cshtml", { UserId: userId }, function () {
                        $("#action").attr('value', "Add");
                        $("#userAssigned").attr('value', userId);
                        $("form[name=assignToLeader]").submit();
                    });
                    $(this).dialog("close");
                }
                },
                          { text: "Cancel", click: function () { $(this).dialog("close"); } }]
            });
        });

        $("a[id*=removeLeader]").click(function () {
            var userId = $(this).attr("id").match("[0-9].*").toString();
            $.post("/Leader/ManageMembers.cshtml", { UserId: userId, Action: "Remove" }, function (data) { });
            location.reload();
        });
        // $("#nav1").css({'background-color': 'blue','border-right' : '1px solid #d4d4d4', 'border-left':'1px solid #d4d4d4'});
        $("#nav1").attr('class', 'componentActive');
        $("#nav1 a").css('color', 'blue');
    });
</script>

<form method="post" action="/Leader/MemberProfile">
    @if(grid == null){
        Response.Redirect("~/Account/Logout");
    }
    @if(grid.TotalRowCount ==0){
        <div>You don't have any members now.</div>
    }
    else{
        @grid.GetHtml(
        tableStyle: "grid",    
        headerStyle: "gridheader",
        footerStyle: "gridfooter",           
        columns: grid.Columns(            
            grid.Column(
                header: "Name",
                format: @<text>@item.FirstName @item.LastName</text>
                ),
            grid.Column(
                columnName: "UserCompanyId",
                header: "Empl. ID"
                ),
            grid.Column(
                columnName: "Email"
            ),
            grid.Column(
                header: "Title",
                format: @<text>TBD</text>
            ),
            grid.Column(
                header: "Role",
                format: @<text>@Roles.GetRolesForUser(item.Email).GetValue(0)</text>
            ),
            grid.Column(
                header: "Leader",
                format: @<text>
                            @if(item.LeaderId !=0){
                                   var leader =  db.QuerySingle("SELECT FirstName,LastName FROM UserProfile WHERE UserId=@0",item.LeaderId);
                                   <span>@leader.FirstName  @leader.LastName</span>
                                  if(User.IsInRole("PM")){                                      
                                      <a href="#" id="assignLeader_@item.UserId">Edit</a>
                                      <a href="#" id="removeLeader_@item.UserId">Remove</a>
                                  }
                              }
                              else{
                                  if(Roles.GetRolesForUser(item.Email).GetValue(0) == "MEMBER" && User.IsInRole("PM")){
                                      <a href="#"id="assignLeader_@item.UserId">Assign</a>
                                  }
                              }
                        </text>
             ),                
            grid.Column(
                header: string.Empty,
                format: @<input type="radio" value="@item.UserId" name="UserId"></input>
            )      
            )
        )
        <input type="submit" name="action" id="viewMemberDetails" value="View Profile" style="width: 120px" >
    }
    
</form>

<div id="dialog" style="display: none">
    <form method="post" name="assignToLeader">
        <h5>Please choose a leader below:</h5>
        @Html.DropDownList("listLeader",Functions.getResources(WebSecurity.CurrentUserName,false,"LEADER"))
        <input type="hidden" id="userAssigned" name="UserId">
        <input type="hidden" id="action" name="Action">        
    </form>
</div>

<div id="js">
</div>

*@