@{
    Layout = "";
    var db = Database.Open("StarterSite");
    int chosenTestType = 0;    
    int chosenPrjId=0;
    string startedDate = "";
    string endDate ="";
    var currentFirstOfWeek = Functions.FirstDateOfWeek(DateTime.Now);

    /* Process section
    ------------------------------------
    */
    if(IsPost){
        chosenTestType = Request["TestType"].AsInt();
        chosenPrjId = Request["CurrentProjectId"].AsInt();
        startedDate=Request["StartedDate"];
        endDate= Request["EndDate"];
        currentFirstOfWeek=Request["CurrentFirstOfWeek"]==""?Functions.FirstDateOfWeek(DateTime.Now):Request["CurrentFirstOfWeek"].AsDateTime();
                
        <p>TestType: @chosenTestType</p>
        <p>currentPrjectId: @chosenPrjId</p>
        <p>startedDate: @startedDate</p>
        <p>endDate: @endDate</p>
        <p>Current : @currentFirstOfWeek</p>
    }
}
<script>
    $("#tabs").tabs();
    $("#accordion").accordion();    
</script>

<style>
    .taskField{
        width: 350px;
    }
</style>


@{
var lsOfProjectUserId = db.Query("SELECT * FROM Project_User WHERE ProjectId=@0",chosenPrjId);
<h2>@Functions.getProjectDetails(chosenPrjId).ProjectName - @Functions.getTestType(chosenTestType).Name - @currentFirstOfWeek.ToShortDateString() to @currentFirstOfWeek.AddDays(6).ToShortDateString()</h2>
var timesheetReports = db.Query("SELECT DISTINCT(Datetime) FROM TimeManagement WHERE( @0 = Datetime)",currentFirstOfWeek.ToShortDateString());
foreach(var ts in timesheetReports){

//Get members in project in specific time
    var lsMemberInDuration = Functions.getUsersInProject(chosenPrjId,ts.Datetime.ToShortDateString());
    <div id="accordion">

        @foreach(var mem in lsMemberInDuration){
        <h3>@Functions.getUserInfo(mem.UserId).FirstName</h3>
        bool displayAcceptButton = false;
        <div><form>@{
        var listCategory = Functions.getListCategory();
        foreach(var cate in listCategory){
                        
            //GIAI NGHIA QUERY: LAY HET ~ COT TRONG TIMEMANAGEMENT CO' THOI GIAN LA @0 VA
            // NAM TRONG CATEGORY @1 VA THUOC LOAI  @2 VA PHAI NAM TRONG PROJECT @3
                var currentDataTS = db.Query("SELECT * FROM TimeManagement WHERE Datetime=@0 "+
                                        "AND TaskId IN (SELECT Id FROM Tasks WHERE CategoryId=@1 AND TypeId=@2) "+
                                        "AND Project_UserId IN (SELECT Id FROM Project_User WHERE ProjectId=@3 AND UserId=@4)",
                                ts.Datetime.ToShortDateString(),cate.Id,chosenTestType,chosenPrjId,mem.UserId);

            if(currentDataTS.Count >0){
                <div>@cate.Name</div>
                WebGrid gridData = new WebGrid(currentDataTS,canSort:false,rowsPerPage:100);                
                <div> 
                    @gridData.GetHtml(
                    columns: gridData.Columns(
                        gridData.Column("TaskId","Task Name",@<text>@Functions.getTaskName(item.TaskId)</text>,"taskField"),
                        gridData.Column("Mon",format:@<span>@if(item.Mon != -1){<text>@item.Mon</text>}</span>),
                        gridData.Column("Tue",format:@<span>@if(item.Tue != -1){<text>@item.Tue</text>}</span>),
                        gridData.Column("Wed",format:@<span>@if(item.Wed != -1){<text>@item.Wed</text>}</span>),
                        gridData.Column("Thu",format:@<span>@if(item.Thu != -1){<text>@item.Thu</text>}</span>),
                        gridData.Column("Fri",format:@<span>@if(item.Fri != -1){<text>@item.Fri</text>}</span>),
                        gridData.Column("Sat",format:@<span>@if(item.Sat != -1){<text>@item.Sat</text>}</span>),
                        gridData.Column("Sun",format:@<span>@if(item.Sun != -1){<text>@item.Sun</text>}</span>)
                    )
                    )
                </div> 
                displayAcceptButton = true;                           
                }
                        
        }
        if(displayAcceptButton){
            <input type="text" value="@currentFirstOfWeek.ToShortDateString()">
            <input type="text" value="@Functions.getProjectUserId(mem.UserId,chosenPrjId)">
            <input type="submit" value="Accept">
            <input type="submit" value="Decline">}
        }                        
        </form>
        </div>
    }
    </div>
}
    
    
}

@*
// Date: 1/1/1753 is MinValue of SQL
        startedDate = startedDate==""?DateTime.Parse("1/1/1753").ToShortDateString():startedDate;
        endDate = endDate==""?DateTime.Parse("1/1/9999").ToShortDateString():endDate;
        var timesheetReports = db.Query("SELECT * FROM TimeManagement WHERE( @0 <= Datetime) AND (Datetime <=@1)",startedDate,endDate);
        WebGrid currentDataTS = new WebGrid(timesheetReports);
        currentDataTS.GetHtml();
<div style="float: left; width: 150px;">
    <h2>MEMBERS</h2>
    <ul>
        @{
            var memberlist = Functions.getUsersInProject(chosenPrjId);
            foreach(var member in memberlist){
                <li id="mem_@member.UserId" value="@member.UserId">
                    @member.FirstName
                    <span>(@Functions.getTotalUnapprovedTimeSheet(member.UserId))</span>
                </li>
            }
        }
    </ul>
</div>


<div style="float: right ;width: 850px">  
@if(userId == 0){
    <p>Please select a member on the right</p>
}
else{
    if(userId !=0 && Functions.getTotalUnapprovedTimeSheet(userId) <=0){
        <p>All @db.QueryValue("SELECT FirstName FROM UserProfile WHERE UserId=@0",userId)'s time sheet reports are approved</p>
    }
    else{    
    <div id="tabs">
         <ul>
             @foreach(var item in unapprovedProject){
                <li><a href="#tab_@item.Id"><span>@item.ProjectName</span></a></li>
             }
        </ul>
        @foreach(var prj in unapprovedProject){
            <div id="tab_@prj.Id">
                @{
                    var userInfo = Functions.getUserInfo(userId);
                    var projectInfo = Functions.getProjectDetails(prj.Id);
                    DateTime firstDayofWeek = Functions.FirstDateOfWeek(DateTime.Now.Year,prj.WeekOfYear);

                    <h4 style="color: #808080">@userInfo.FirstName @userInfo.LastName - 
                        <span style="color: #0026ff">@projectInfo.ProjectName</span>
                        <br> 
                        <span style="color: #000">From:</span> @firstDayofWeek.ToShortDateString() 
                        <span style="color: #000">To:</span>@firstDayofWeek.AddDays(7).ToShortDateString()
                    </h4> 
                    //GET CATEGORIES 
                    var categoriesList = db.Query("SELECT Id FROM Categories");
                    <form method="post">
                        @foreach(var category in categoriesList){

                            //GET TIMESHEET FOR ABOVE CATEGORIES IN WORKING PROJECT 
                            var timesheet = db.Query("SELECT Tasks.Name,Mon,Wed,Tue,Thu,Fri,Sat,Sun,Categories.Name AS CategoryName FROM TimeManagement,Tasks,Categories " +
                                                    "WHERE Project_UserId=@0 AND TimeManagement.TaskId = Tasks.Id AND Categories.Id = Tasks.CategoryId AND Categories.Id=@1",prj.Id,category.Id);
                            if(timesheet.Count >0 ){

                                //SHOW CATEGORY NAME
                               <h4 style="color: #f00">@timesheet[0].CategoryName.ToUpper()</h4>
                                var newGrid = new WebGrid(timesheet,canSort:false,rowsPerPage:50);                                   
                                @newGrid.GetHtml(
                                    columns: newGrid.Columns(
                                        newGrid.Column("Name","Task Name",null,"taskField"),
                                        newGrid.Column("Mon",format:@<span>@if(item.Mon != -1){<text>@item.Mon</text>}</span>),
                                        newGrid.Column("Tue",format:@<span>@if(item.Tue != -1){<text>@item.Tue</text>}</span>),
                                        newGrid.Column("Wed",format:@<span>@if(item.Wed != -1){<text>@item.Wed</text>}</span>),
                                        newGrid.Column("Thu",format:@<span>@if(item.Thu != -1){<text>@item.Thu</text>}</span>),
                                        newGrid.Column("Fri",format:@<span>@if(item.Fri != -1){<text>@item.Fri</text>}</span>),
                                        newGrid.Column("Sat",format:@<span>@if(item.Sat != -1){<text>@item.Sat</text>}</span>),
                                        newGrid.Column("Sun",format:@<span>@if(item.Sun != -1){<text>@item.Sun</text>}</span>)
                                    )                       
                                ); 
                            }
                        }
                        
                        <input type="hidden" name="timeSheetForProjectUser" value="@prj.id">
                        <input type="submit" name="action" id="btnAccept" value="Accept" style="width: 100px">
                        <input type="submit" name="action" value="Decline" style="width: 100px">
                        <input type="hidden" name="MemberUserId" value="@Request["MemberUserId"]" >
                    </form>
                }
            </div>
        }
    </div>
    }
}

</div>
*@