@{
    var db = Database.Open("StarterSite");    
    WebGrid grid = null;
    int counter = 0;
}
<script>
    $(function () {
        $("button#og-add-new-task").click(function (event) {
            event.preventDefault();
            $("div#og-add-new-task").dialog({
                buttons: [
                    { text: "Add",
                        click: function () {
                            var taskName = $("input#og-add-task-name").val();
                            var testTypeId = $("select#og-mt-list-test-type").find(":selected").val();
                            var cateId = $("select#og-mt-category-list").find(":selected").val();
                            var posting = $.post("/Admin/Processing.cshtml", { Action: "AddNewTask", TaskName: taskName, TestTypeId: testTypeId, CategoryId: cateId });
                            posting.done(function (data) {
                                $("div#og-add-new-task").dialog("close");
                                location.reload();
                            });
                        }
                    },
                    { text: "Cancel",
                        click: function () {
                            $("div#og-add-new-task").dialog("close");
                        }
                    }
                ]
            });
        });
    });

    //SET CSS FOR ACTIVE TAB
    $("#nav3").attr('class', 'componentActive');
    $("#nav3 a").css('color', 'blue');
    $("#sub-nav3").removeClass('hidden').addClass('shown');
</script>

<div>
    <form method="post">
        <div class="mt-line-up">
            <label><strong>Category :</strong></label>
            @Html.DropDownList("mt-cateList",null,Functions.getSelectListCategory(true),Request["mt-cateList"],null)
        </div>

        <div class="mt-line-up">
            <label><strong>Test Type :</strong></label>
            @Html.DropDownList("mt-testypeList",null,Functions.getSelectListTestType(true),Request["mt-testypeList"],null)
        </div>

        <div class="mt-line-up">
            <input name="mt-task-name" type="text" placeholder="Task name" value="@Request["mt-task-name"]" style="width: 250px">
        </div>

        <div class="mt-line-up">
            <button class="tk-button">Search</button>
            <button class="tk-button" id="og-add-new-task">Add new</button>
        </div>
    </form>
</div>

@if(IsPost){
    var chosenCategoryId = Request["mt-cateList"].AsInt();
    var chosenTestType = Request["mt-testypeList"].AsInt();
    var chosenTaskName = Request["mt-task-name"];

    //chosenCategoryId =0 or chosenTestType = 0 mean that user is choosing "All" in drop down list;
    var queryFilterCategory = chosenCategoryId ==0?"(SELECT Id FROM Categories) ": "(SELECT Id FROM Categories WHERE Id=@0) ";
    var queryFilterTestType = chosenTestType ==0?"(SELECT Id FROM TestType) ": "(SELECT Id FROM TestType WHERE Id=@1) ";
    
    var queryFilteredTasks = "SELECT * FROM Tasks WHERE " +
                        "CategoryId IN " + queryFilterCategory +
                        "AND TypeId IN " + queryFilterTestType +
                        "AND (Name LIKE @2)";

@*
    <p>@queryFilteredTasks</p>
    <p>@chosenCategoryId</p>
    <p>@chosenTestType</p>
    <p>@chosenTaskName</p>
  *@  
    var filterTasks = db.Query(queryFilteredTasks,chosenCategoryId,chosenTestType,"%"+chosenTaskName+"%");
    grid = new WebGrid(filterTasks,rowsPerPage:100,defaultSort: "CategoryId", canSort:false);
}
else{
   var listTasks = Functions.getAllTasks();
   grid= new WebGrid(listTasks,rowsPerPage:100,defaultSort: "CategoryId",canSort: false);
  
}

<div style="margin-top: 30px; margin-bottom: 30px">
    @grid.GetHtml(
        headerStyle: "gridheader",
        columns: grid.Columns(
            grid.Column(header:"No.",format:@<div style="text-align: center">@{counter++;}@counter</div>),
            grid.Column("Name"),
            grid.Column("TypeId",format:@<text>@Functions.getTestType(item.TypeId).Name</text>),
            grid.Column("CategoryId",format:@<text>@Functions.getCategoryName(item.CategoryId)</text>)
        )    
    )  
</div>

<div title="Add new task" id="og-add-new-task" class="hidden">
    <div style="margin: 10px;">
        <label style="font-size: smaller"><strong>Task Name</strong></label>
        <br>
        <input type="text" id="og-add-task-name">
    </div>
    <div style="margin: 10px">
        <label style="font-size: smaller"><strong>Test Type</strong></label>
        <br>
        @Html.DropDownList("og-mt-list-test-type",Functions.getSelectListTestType())
    </div>
    <div style="margin: 10px">
        <label style="font-size: smaller"><strong>Category</strong></label>
        <br>
        @Html.DropDownList("og-mt-category-list",Functions.getSelectListCategory())
    </div>
</div>